<div align="center">

```
  ___  ____  ____   ___  ____  ___
 / __)( ___)(  _ \ / __)(_  _)/ _ \
 \__ \ )__)  )   /( (_-. _)(_( (_) )
 (___/(____)(__\_)\___/(____)\___/

  .-""""""-.
 .'           '.
 /    O       O   \
 :       \__/      :
 |     ________    |
 :   /         \   :
 \ | ~~~~~~~~ | /
  '.\         /.'
  '-......-'
```

**Your AI teammate that turns Trello cards into pull requests.**

Write a task. Drop it in a list. Get a PR.

[Getting Started](#getting-started) · [How It Works](#how-it-works) · [Configuration](#configuration) · [Customizing Prompts](#customizing-prompts)

</div>

---

Sergio is a self-hosted bot that connects your **Trello board** to **Claude AI**. Write a task card, drop it in the right list, and Sergio generates an implementation plan, writes the code, runs your tests, and opens a pull request — without you touching the terminal.

It runs on a single VM, polls your board every 60 seconds, and uses sandboxed Claude CLI sessions to do the actual work. No external SaaS, no vendor lock-in, fully open source.

### What it does

1. **Plans** — Reads your Trello card and generates a detailed implementation plan using Claude
2. **Reviews** — Posts the plan as a card comment and moves it for human approval
3. **Implements** — Once approved, writes the code in an isolated git worktree
4. **Tests** — Runs your test suite automatically
5. **Ships** — Commits, pushes to a feature branch, and opens a pull request

All triggered from a Trello card. You stay in the loop at every step.

---

## How It Works

Sergio uses a 7-list Trello board as its interface. Cards flow left-to-right through two pipelines:

```
Planning pipeline:

  TODO --> Task Revision --> Reviewing --> TODO Reviewed
              Sergio            Sergio         You review
              generates         posts the      the plan
              a plan            plan here       and approve

Development pipeline:

  Task Development --> Developing --> Task Developed
       You move            Sergio         PR created,
       card here           writes code    ready for
                           + runs tests   code review
```

The bot polls both pipelines concurrently. Planning takes minutes. Development creates a git worktree, runs your dev environment, executes tests, and pushes to GitHub.

**Feedback loop:** If a plan isn't right, add a comment explaining what to change and move the card back. Sergio re-reads the card — including your feedback — and generates an updated plan.

---

## Getting Started

### Prerequisites

- A Linux VM (Ubuntu/Debian recommended)
- [Node.js](https://nodejs.org/) >= 18
- A [Trello](https://trello.com) account with [API key and token](https://trello.com/power-ups/admin)
- An [Anthropic API key](https://console.anthropic.com/)
- A [GitHub](https://github.com) personal access token

### Quick start

```bash
# Clone and install
git clone https://github.com/AlfredoProgworker/sergio.git /opt/sergio
cd /opt/sergio
npm install

# Run the interactive setup wizard
npm run setup

# Start
npm start
```

### What the setup wizard does

- **Checks system dependencies** — Node, Git, [Claude CLI](https://docs.anthropic.com/en/docs/claude-code), [GitHub CLI](https://cli.github.com/) — and offers to install any that are missing
- **Creates a `claudeuser`** system account for sandboxed Claude execution
- **Collects your API keys** — Anthropic, Trello, GitHub
- **Creates a Trello board** with 7 pre-configured workflow lists (or connects to an existing board)
- **Generates config files** — `sergio.config.json` and `.env`
- **Copies prompt templates** — editable Markdown files that control Claude's behavior

### Run as a systemd service (recommended for production)

```bash
sudo cp sergio.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable sergio
sudo systemctl start sergio

# Verify
sudo journalctl -u sergio -f
```

---

## Configuration

Sergio uses two config files. Secrets live in `.env` (never committed). Everything else lives in `sergio.config.json` (generated by setup).

### sergio.config.json

```jsonc
{
  "botName": "Sergio",           // Name used in Trello lists, logs, branch prefixes
  "trello": {
    "boardId": "...",
    "lists": { /* list IDs set automatically by setup */ }
  },
  "github": { "repoUrl": "https://github.com/you/your-repo" },
  "repoDir": "/opt/your-repo",  // Path to the repo Sergio works on
  "worktreeBaseDir": "/opt/worktrees",
  "urlAllowList": [],            // URLs Claude is allowed to access (see Security)
  "prompts": {
    "revisionTemplate": "prompts/revision.md",
    "developmentTemplate": "prompts/development.md"
  },
  "timeouts": {
    "claudeDevMs": 1200000,      // 20 min
    "sstDevMs": 600000,          // 10 min
    "testMs": 600000             // 10 min
  },
  "pollIntervalMs": 60000       // 1 min
}
```

### .env

```
ANTHROPIC_API_KEY=sk-ant-...
TRELLO_API_KEY=...
TRELLO_TOKEN=...
GITHUB_TOKEN=ghp_...
```

### Re-configuring

Run `npm run setup` again at any time. If `sergio.config.json` exists, the wizard asks what to update — Trello board, GitHub, URL allow list, or prompts — without recreating everything.

---

## Customizing Prompts

Sergio's Claude behavior is driven by two editable Markdown templates:

| File | Used for |
|------|----------|
| `prompts/revision.md` | Planning — Claude generates implementation plans |
| `prompts/development.md` | Development — Claude writes code |

### Placeholders

| Placeholder | Replaced with |
|-------------|---------------|
| `{{botName}}` | Bot name from config |
| `{{cardContent}}` | Full Trello card (description + comments + attachments) |
| `{{urlPolicy}}` | Auto-generated URL restriction policy, or empty string |

Add your coding standards, framework conventions, or architectural constraints directly to these templates. Claude will follow them on every task.

---

## Security

### Sandboxed execution

Claude CLI runs under a dedicated `claudeuser` system account, isolated from your deploy user. This limits what Claude can access on the filesystem.

### URL allow list

When `urlAllowList` is configured, Sergio enforces it at two levels:

**Prompt-level (always active)** — Every Claude session includes:

```
URL ACCESS POLICY: You are ONLY permitted to access these URLs:
- https://docs.example.com
Do NOT fetch, read, or access any URL not on this list.
```

**Network-level (optional)** — For defense-in-depth:

```bash
sudo bash scripts/setup-firewall.sh
```

Configures `iptables` so `claudeuser` can only reach Trello, GitHub, and your allow-listed hosts. All other outbound traffic is dropped.

---

## Project Structure

```
src/
  config.ts            Config loader (sergio.config.json + .env)
  index.ts             Entry point with concurrent polling loops
  trello.ts            Trello REST API client
  processor.ts         Planning pipeline (card to Claude to plan to comment)
  dev-processor.ts     Dev pipeline (worktree to Claude to tests to PR)
  claude.ts            Claude CLI runner for planning
  claude-dev.ts        Claude CLI runner for development
  template.ts          Prompt template engine
  list-names.ts        Dynamic list name generator
  state.ts             Planning state persistence
  dev-state.ts         Dev state persistence
  setup/
    index.ts           Setup wizard orchestrator
    prompts.ts         Interactive question flow
    trello-setup.ts    Board and list creation via Trello API

prompts/               Editable prompt templates
scripts/               Firewall and utility scripts
```

---

## FAQ

<details>
<summary><strong>Why Trello?</strong></summary>

Trello is a simple, visual interface that non-technical team members already know. No CLI to learn, no new app to install — just drag a card.
</details>

<details>
<summary><strong>Why Claude CLI instead of the API directly?</strong></summary>

Claude CLI provides full agentic capabilities — reading files, navigating the codebase, running tools — in a sandboxed session. The raw API alone does not give you that.
</details>

<details>
<summary><strong>Can I change the bot name?</strong></summary>

Yes. Set `botName` during setup (or edit `sergio.config.json`) and all list names, log messages, and branch prefixes update automatically.
</details>

<details>
<summary><strong>Can I use an existing Trello board?</strong></summary>

Yes. During setup, choose not to create a new board and provide your board and list IDs manually.
</details>

<details>
<summary><strong>What if Claude's plan is wrong?</strong></summary>

Add a comment to the card explaining what needs to change, then move it back to the task revision list. Sergio detects it, re-reads the card including your feedback, and generates an updated plan.
</details>

<details>
<summary><strong>Is this production-ready?</strong></summary>

Sergio is used in production by its creators. That said, it is early-stage open source — test in a non-critical environment first and report any issues.
</details>

---

## Contributing

Contributions are welcome! Please [open an issue](https://github.com/AlfredoProgworker/sergio/issues) to discuss what you'd like to change before submitting a PR.

```bash
git clone https://github.com/AlfredoProgworker/sergio.git
cd sergio
npm install
npm run setup
npm start
```

---

<div align="center">

**[MIT License](LICENSE)**

</div>
